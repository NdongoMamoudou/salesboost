# Generated by ChatGPT
version: "3.9"

services:

  # --- HADOOP HDFS ---
  namenode:
    image: bde2020/hadoop-namenode:2.0.0-hadoop3.2.1-java8
    container_name: namenode
    restart: always
    ports:
      - "9870:9870"
      - "9000:9000"
    volumes:
      - hadoop_namenode:/hadoop/dfs/name
    environment:
      CLUSTER_NAME: salesboost
    env_file:
      - ./hadoop.env
    networks:
      - sbnet

  datanode:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: datanode
    restart: always
    volumes:
      - hadoop_datanode:/hadoop/dfs/data
    environment:
      SERVICE_PRECONDITION: "namenode:9870"
    env_file:
      - ./hadoop.env
    depends_on:
      - namenode
    networks:
      - sbnet


  # --- SPARK ---
  spark-master:
    image: bde2020/spark-master:3.3.0-hadoop3.3
    container_name: spark-master
    ports:
      - "8080:8080"
      - "7077:7077"
    environment:
      INIT_DAEMON_STEP: setup_spark
    depends_on:
      - namenode
    networks:
      - sbnet
    volumes:
      - ../../data-pipeline/spark:/app

  spark-worker-1:
    image: bde2020/spark-worker:3.3.0-hadoop3.3
    container_name: spark-worker-1
    depends_on:
      - spark-master
    environment:
      SPARK_MASTER: spark://spark-master:7077
    networks:
      - sbnet
      
  
  spark-worker-2:
    image: bde2020/spark-worker:3.3.0-hadoop3.3
    container_name: spark-worker-2
    depends_on:
      - spark-master
    environment:
      SPARK_MASTER: spark://spark-master:7077
    networks:
      - sbnet



  # --- KAFKA + ZOOKEEPER ---
  zookeeper:
    image: wurstmeister/zookeeper
    container_name: zookeeper
    ports:
      - "2181:2181"
    networks:
      - sbnet

  kafka:
    image: wurstmeister/kafka
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    depends_on:
      - zookeeper
    networks:
      - sbnet


  # --- MONGODB ---
  mongo:
    image: mongo:6
    container_name: mongo
    restart: always
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - sbnet


  # --- REDIS ---
  redis:
    image: redis:7
    container_name: redis
    restart: always
    ports:
      - "6379:6379"
    networks:
      - sbnet


  # --- FASTAPI SERVICE ---
  fastapi:
    build:
      context: ../../
      dockerfile: infra/docker/Dockerfile.api
    container_name: fastapi
    restart: always
    ports:
      - "8000:8000"
    volumes:
      - ../../backend:/app
    environment:
      KAFKA_HOST: kafka:9092
      MONGO_URL: mongodb://mongo:27017
      REDIS_HOST: redis
      HDFS_URL: hdfs://namenode:9000
    depends_on:
      - kafka
      - mongo
      - redis
      - spark-master
    networks:
      - sbnet

# -----------------
# Networks & Volumes
# -----------------
networks:
  sbnet:
    driver: bridge

volumes:
  hadoop_namenode:
  hadoop_datanode:
  mongo_data:
